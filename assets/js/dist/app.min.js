"use strict";var controllers=angular.module("cafehopApp.controllers",["google-maps".ns()]),services=angular.module("cafehopApp.services",[]),factories=angular.module("cafehopApp.factories",[]),directives=angular.module("cafehopApp.directives",[]),cafehop=angular.module("cafehopApp",["cafehopApp.controllers","cafehopApp.services","cafehopApp.factories","cafehopApp.directives","ngRoute","ngSanitize"]);angular.module("cafehopApp").config(["$routeProvider","$httpProvider",function(a,b){a.when("/",{templateUrl:"app/map/views/map.html",title:"Cafehop KL - Mapping unique cafes around Malaysia"}).when("/about",{templateUrl:"app/about/views/about.html",controller:"AboutController",title:"About"}).when("/contact",{templateUrl:"app/contact/views/contact.html",title:"Contact"}).when("/faq",{templateUrl:"app/faq/views/faq.html",controller:"FaqController",title:"FAQ"}).when("/map",{templateUrl:"app/map/views/map.html",controller:"MapController",title:"Map"}).when("/cafe/:cafe_id/:cafe_name?",{templateUrl:"app/cafe/views/cafe.html",controller:"CafeController",title:"Cafe"}),b.defaults.useXDomain=!0,delete b.defaults.headers.common["X-Requested-With"]}]),angular.module("cafehopApp").run(["$rootScope",function(a){a.$on("$routeChangeSuccess",function(a,b){window.document.title=b.title+" | Cafehop KL",console.log(b.title)})}]),angular.module("cafehopApp.controllers").controller("AboutController",["$scope","$http",function(a,b){var c="app/about/models/team.json";b.get(c).success(function(b){a.team=b.team}).error(function(){console.error(c+" not found.")})}]),angular.module("cafehopApp.controllers").controller("MapController",["$scope","$http","$rootScope","CafeService","MapCafes","MapDefaults","MarkerCallbacks",function(a,b,c,d,e,f,g){c.hideFooter=!0,c.fullContainer=!0,c.$on("$locationChangeStart",function(){c.hideFooter=!1,c.fullContainer=!1}),a.markers=[],a.markersControl={},a.mapCafes=e,a.mapDefaults=f,a.initialized=!1,a.idKeyCounter=0,a.cafes=a.mapCafes.cafes,a.legend=f.legend,a.infoWindow={marker:null,model:null,coords:{},options:a.mapDefaults.marker.windowOptions},a.sponsors={0:{name:"Sponsor A"},1:{name:"Sponsor B"}},a.fitMarkerBounds=function(){if(a.instance){var b=new google.maps.LatLngBounds;angular.forEach(a.markers,function(a){var c=a.coords;b.extend(new google.maps.LatLng(c.latitude,c.longitude))}),a.instance.panToBounds(b),a.instance.fitBounds(b)}},a.panToUser=function(){var b=a.findMarker(a.userMarker.idKey);if(b){var c=b.getPosition();a.instance.panTo(c)}},a.placeDefaultUser=function(b){b.coords=a.mapDefaults.center;var c=new google.maps.LatLng(a.mapDefaults.center.latitude,a.mapDefaults.center.longitude);a.instance.panTo(c)},a.getUserLocation=function(){a.panToUser(),navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(b){a.loadingCafes=!0,a.userMarker.coords=b.coords;var c=new google.maps.LatLng(b.coords.latitude,b.coords.longitude);a.instance.panTo(c),a.getCafes(c)})},a.ready=function(b){a.initialized||(a.initialized=!0,a.instance=b,a.$apply(function(){a.userMarker={idKey:a.idKeyCounter++,icon:f.icons.current,options:{draggable:!0},window:{options:f.marker.windowOptions},isNotUser:function(){return!1}},a.placeDefaultUser(a.userMarker),a.getUserLocation(),a.markers.push(a.userMarker),a.setWindowMarker(a.userMarker),a.markers.length<=1&&a.addMarkers(a.cafes),a.markerCallbacks=g.init({map:a.instance,llCallback:a.getCafes,showWindow:a.setWindowMarker,userMarker:a.userMarker}),a.markerEvents=a.markerCallbacks.getEvents()}))},a.getCafes=function(b){var c;b&&(c=b.lat()+","+b.lng());var d=function(b){a.loadingCafes=!1,a.addMarkers(b)};a.mapCafes.getCafes({before:function(){a.loadingCafes=!0},success:d,ll:c})},a.map={center:angular.copy(a.mapDefaults.center),zoom:13,events:{tilesloaded:a.ready},options:{scrollwheel:!1,mapTypeControl:!1},showWindow:!1},a.addMarkers=function(b){b.length<1||!a.initialized||(a.markers=[],a.markers.push(a.userMarker),angular.forEach(b,function(b){var c={idKey:a.idKeyCounter++,icon:f.icons.cafe,coords:{latitude:b.lat,longitude:b.lng},cafe:b,window:{iconVisible:!0,closeClick:!0,options:a.mapDefaults.marker.windowOptions},options:{title:b.name,draggable:!1},isNotUser:function(){return this.idKey!=a.userMarker.idKey}};b.idKey=c.idKey,a.markers.push(c)}),a.fitMarkerBounds())},a.getPhotoUrl=function(a){var b=a.photos;if(b.count>0){var c=b.items[0];return c.url}},a.getPhotoStyle=function(b){return{"background-image":"url("+a.getPhotoUrl(b)+")"}},a.getCafeUrl=function(a){if(a){var b=a.name.replace("/","");return"#cafe/"+a.id+"/"+encodeURIComponent(b)}return"#"},a.setWindowMarker=function(b){a.infoWindow.model=b,a.map.showWindow=!0,a.infoWindow.coords=b.coords},a.triggerMarkerMouseout=function(b){var c=a.findMarker(b);c&&google.maps.event.trigger(c,"mouseout")},a.triggerMarkerMouseover=function(b){var c=a.findMarker(b);c&&google.maps.event.trigger(c,"mouseover")},a.findMarker=function(b){var c,d=a.markersControl.getGMarkers();for(var e in d)d[e].key==b&&(c=d[e]);return c},a.init=function(){a.getCafes()},a.init()}]),angular.module("cafehopApp.controllers").controller("FaqController",["$scope","$http",function(a,b){var c="app/faq/models/faq.json";a.faq="Loading FAQ...",b.get(c).success(function(b){a.faqs=b.faqs}).error(function(){console.error(c+" not found.")})}]),angular.module("cafehopApp.controllers").controller("CafeController",["$scope","$http","$routeParams","$sce","CafeService","GMapCredentials",function(a,b,c,d,e,f){e.init(),window.scrollTo(0,0),a.loading=!0;var g=c.cafe_id;a.cafe=e.cafe,a.cafe.name=c.cafe_name,window.document.title=c.cafe_name+" | Cafehop KL",e.getCafe({id:g,success:function(){a.cafe=e.cafe,a.loading=!1,window.document.title=a.cafe.name+" | Cafehop KL",a.cafe.src=d.trustAsResourceUrl(a.getEmbedMapSrc(a.cafe))}}),a.getEmbedMapSrc=function(a){var b=a.name+","+a.address1+","+a.city;return b=encodeURIComponent(b),console.log(b),"https://www.google.com/maps/embed/v1/search?key="+f.apiKey+"&q="+b}}]),angular.module("cafehopApp.services").service("CafeService",["$http",function(a){function b(a){var b=a.ll,c=a.name+", "+a.address1;a.address2&&(c+=" "+a.address2);var d=encodeURIComponent(a.city);b=encodeURIComponent(b),c=encodeURIComponent(c);var e="http://maps.google.com/maps?f=d&near="+d+"&ll="+b+"&daddr="+c+"&iwloc=addr&iwd=1";return e}var c={},d={cafe:{},init:function(){this.cafe={}},getCafe:function(b){var e="http://cafehop.my/api/sherminn/cafe.php";return a({url:e,method:"GET",params:{id:b.id}}).success(function(a){d.cafe=a.response.store,d.initCafe(),b.success&&b.success(a)}).error(function(){console.error(e+" cannot be accessed.")}),c},setCafe:function(a){c=a},initCafe:function(a){a||(a=d.cafe),a.directions=b(a)}};return d}]),angular.module("cafehopApp.services").service("MapCafes",["$http","MapDefaults",function(a,b){var c=b,d="http://cafehop.my/api/sherminn/featured.php",e={getCount:0,cafes:[],getCafes:function(b){var f=++this.getCount;b.before(),b=b||{},b.radius=b.radius||3e3,b.offset=b.offset||0,b.limit=b.limit||30;var g={ll:b.ll||c.center.latitude+","+c.center.longitude,radius:b.radius,offset:b.offset,limit:b.limit};a({url:d,method:"GET",params:g}).success(function(a){return function(c){if(a==e.getCount){for(var d=c.response.venues;e.cafes.length>0;)e.cafes.pop();e.cafes.push.apply(e.cafes,d),b.success&&b.success(e.cafes)}}}(f)).error(function(){console.error(d+" cannot be accessed.")})},setCafe:function(a){cafe=a}};return e}]),angular.module("cafehopApp.factories").factory("MapDefaults",function(){var a={center:{latitude:3.1537569458852315,longitude:101.71610355377197},marker:{windowOptions:{maxWidth:160,maxHeight:500,pixelOffset:new google.maps.Size(0,-32)}},legend:[{img:"assets/images/map-icons/chkl-pin-03.png",text:"Open"},{img:"assets/images/map-icons/chkl-pin-01.png",text:"Closed"}],icons:{current:"assets/images/map-icons/chkl-pin-me.png",cafe:"assets/images/map-icons/chkl-pin-03.png",cafeClosed:"assets/images/map-icons/chkl-pin-01.png",active:"assets/images/map-icons/chkl-pin-02.png"}};return a}),angular.module("cafehopApp.factories").factory("MarkerCallbacks",["MapDefaults",function(a){var b={map:null,allowMouseover:!0,currMouseoverId:-1,latLngChangeCallback:null,showWindow:null,disableMouseover:function(){this.allowMouseover=!1},enableMouseover:function(){this.allowMouseover=!0},hideWindowMarker:function(){this.map.showWindow=!1},currentMarkerDragStart:function(){this.disableMouseover(),this.hideWindowMarker()},currentMarkerDragEnd:function(a,b,c){var d=a.getPosition();this.map.panTo(d),this.latLngChangeCallback(d),c.coords={latitude:a.getPosition().lat(),longitude:a.getPosition().lng()},this.enableMouseover()},onMarkerMouseover:function(b,c,d){this.allowMouseover&&d&&d.isNotUser()&&(b.setIcon(a.icons.active),b.setZIndex(google.maps.Marker.MAX_ZINDEX+1),this.currMouseoverId=d.idKey,this.showWindow(d))},onMarkerMouseout:function(a,b,c){this.allowMouseover&&c&&c.isNotUser()&&a.setIcon(c.icon)},onMarkerClick:function(a,b,c){if(c.idKey!=this.userMarker.idKey){this.showWindow(c);var d=$("#"+c.idKey,".cafe-list").position().top;$(".cafe-list").animate({scrollTop:d})}},getEvents:function(){return{dragend:this.currentMarkerDragEnd.bind(b),dragstart:this.currentMarkerDragStart.bind(b),mouseover:this.onMarkerMouseover.bind(b),mouseout:this.onMarkerMouseout.bind(b),click:this.onMarkerClick.bind(b)}},init:function(a){return this.map=a.map,this.latLngChangeCallback=a.llCallback,this.showWindow=a.showWindow,this.userMarker=a.userMarker,this}};return b}]),angular.module("cafehopApp.factories").factory("GMapCredentials",function(){return{apiKey:"AIzaSyCWxCU3sy8rPbxrFZf74O80GB5MH8PIFBI"}}),angular.module("cafehopApp.directives").directive("resize",["$window",function(a){return function(b){var c=angular.element(a);b.getWindowSize=function(){return{h:c.height(),w:c.width()}},b.$watch(b.getWindowSize,function(a){b.style=function(){var b=$("header").height(),c=a.h-b;return $(".angular-google-map-container").height(c),{height:c+"px",maxHeight:a.h-b-1+"px"}}},!0)}}]);